name: Claude Security Review

# å·¥ä½œæµæƒé™è®¾ç½®
permissions:
  contents: read          # è¯»å–ä»£ç ä»“åº“
  pull-requests: write    # åœ¨ PR ä¸­å†™å…¥è¯„è®º
  actions: read          # è¯»å– Actions çŠ¶æ€

<<<<<<< HEAD
# è§¦å‘æ¡ä»¶ï¼šåªé’ˆå¯¹ test åˆ†æ”¯çš„ Pull Request
=======
>>>>>>> fix-puppeteer
on:
  push:
    branches: 
      - test
    # åªæ‰«æä»£ç æ–‡ä»¶ï¼Œæ’é™¤æ–‡æ¡£å’Œé…ç½®æ–‡ä»¶
    paths:
      - '**.py'
      - '**.js'
      - '**.jsx'
      - '**.ts'
      - '**.tsx'
      - '**.java'
      - '**.go'
      - '**.php'
      - '**.rb'
      - '**.cs'
      - '**.cpp'
      - '**.c'
      - '**.cc'
      - '**.h'
      - '**.hpp'
      - '**.sql'
      - '**.sh'
      - '**.bash'
      - '**.zsh'
      - '**.ps1'
      - '**.scala'
      - '**.kt'
      - '**.swift'
      - '**.rs'
      # é…ç½®æ–‡ä»¶ä¸­å¯èƒ½æœ‰å®‰å…¨é—®é¢˜
      - '**.yaml'
      - '**.yml'
      - '**.json'
      - '**.xml'
      - '**.toml'
      # æ’é™¤æ–‡æ¡£å’Œæµ‹è¯•æ–‡ä»¶
      - '!**.md'
      - '!**.txt'
      - '!**.rst'
      - '!**/docs/**'
      - '!**/test/**'
      - '!**/tests/**'
      - '!**/*_test.*'
      - '!**/*test*.*'
      - '!**/spec/**'

  # æ‰‹åŠ¨è§¦å‘é€‰é¡¹
  workflow_dispatch:
    inputs:
      force_scan:
        description: 'å¼ºåˆ¶æ‰«ææ‰€æœ‰æ–‡ä»¶'
        required: false
        default: false
        type: boolean

# ç¯å¢ƒå˜é‡
env:
  ALLOWED_REPOSITORIES: "hello-xone/xone_website"
  
jobs:
  # é¢„æ£€æŸ¥ä½œä¸š
  pre-check:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
      repository-allowed: ${{ steps.check.outputs.repository-allowed }}
    
    steps:
      - name: æ£€æŸ¥æ˜¯å¦åº”è¯¥è¿è¡Œæ‰«æ
        id: check
        run: |
          # æ£€æŸ¥ä»“åº“æ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­
          if [[ "${{ env.ALLOWED_REPOSITORIES }}" == *"${{ github.repository }}"* ]]; then
            echo "repository-allowed=true" >> $GITHUB_OUTPUT
            echo "âœ… ä»“åº“ ${{ github.repository }} åœ¨å…è®¸çš„æ‰«æåˆ—è¡¨ä¸­"
          else
            echo "repository-allowed=false" >> $GITHUB_OUTPUT
            echo "âŒ ä»“åº“ ${{ github.repository }} ä¸åœ¨å…è®¸çš„æ‰«æåˆ—è¡¨ä¸­"
            exit 0
          fi
          
          echo "should-run=true" >> $GITHUB_OUTPUT
          echo "âœ… ç›®æ ‡åˆ†æ”¯ä¸º dev æˆ–å¼ºåˆ¶æ‰«æï¼Œå°†æ‰§è¡Œå®‰å…¨æ‰«æ"

  # ä¸»è¦å®‰å…¨æ‰«æä½œä¸š
  claude-security-scan:
    needs: pre-check
    runs-on: ubuntu-latest
    
    # åªæœ‰é€šè¿‡é¢„æ£€æŸ¥æ‰è¿è¡Œ
    if: needs.pre-check.outputs.should-run == 'true' && needs.pre-check.outputs.repository-allowed == 'true'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
<<<<<<< HEAD
        uses: actions/checkout@v4
=======
        uses: actions/checkout@v5
>>>>>>> fix-puppeteer
        with:
          # è·å– PR çš„ HEAD commit
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          # éœ€è¦è·å–è‡³å°‘ 2 ä¸ªæäº¤æ¥æ¯”è¾ƒå·®å¼‚
          fetch-depth: 2
          # ç¡®ä¿è·å–å®Œæ•´çš„ PR ä¿¡æ¯
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‹ æ˜¾ç¤ºæ‰«æä¿¡æ¯
        run: |
          echo "ğŸ” å¼€å§‹ Claude å®‰å…¨æ‰«æ"
          echo "ğŸ“ ä»“åº“: ${{ github.repository }}"
          echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.head_ref }} â†’ ${{ github.base_ref }}"
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "ğŸ“ PR #${{ github.event.pull_request.number }}"
            echo "ğŸ‘¤ ä½œè€…: ${{ github.event.pull_request.user.login }}"
            echo "ğŸ”„ æäº¤: ${{ github.event.pull_request.head.sha }}"
          else
            echo "ğŸ”„ æäº¤: ${{ github.sha }}"
          fi

      - name: ğŸ›¡ï¸ æ‰§è¡Œ Claude å®‰å…¨å®¡è®¡
        uses: anthropics/claude-code-security-review@main
        with:
          # API å¯†é’¥ï¼ˆä» GitHub Secrets è·å–ï¼‰
          claude-api-key: ${{ secrets.CLAUDE_API_KEY }}
          
          # åŸºæœ¬é…ç½®
          comment-pr: true              # åœ¨ PR ä¸­æ·»åŠ å®‰å…¨å‘ç°çš„è¯„è®º
          upload-results: true          # ä¸Šä¼ ç»“æœä½œä¸ºå·¥ä»¶
          
          # è¶…æ—¶è®¾ç½®ï¼ˆåˆ†é’Ÿï¼‰
          claudecode-timeout: 15
          
          # æ’é™¤ç›®å½•è®¾ç½® - ä¸æ‰«æè¿™äº›ç›®å½•
          exclude-directories: "node_modules,vendor,dist,build,out,target,.git,.github,docs,documentation,examples,test,tests,spec,specs,coverage,__pycache__,.pytest_cache,.vscode,.idea,logs,tmp,temp,.next,.nuxt,public/assets,static/assets"
          
          # é«˜çº§é…ç½®
          run-every-commit: false       # é¿å…é‡å¤æ‰«æé™ä½æˆæœ¬

      - name: ğŸ“ ä¸Šä¼ å®‰å…¨æ‰«æç»“æœ
        if: always()  # å³ä½¿å‰é¢æ­¥éª¤å¤±è´¥ä¹Ÿè¦ä¿å­˜ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: claude-security-results-${{ github.event.pull_request.number || github.run_number }}
          path: |
            security-results.json
            *.log
          retention-days: 30

      - name: ğŸ“Š æ˜¾ç¤ºæ‰«æå®Œæˆä¿¡æ¯
        if: always()
        run: |
          echo "ğŸ‰ Claude å®‰å…¨æ‰«æå·²å®Œæˆ"
          echo "ğŸ“„ æ‰«æç»“æœå·²ä¿å­˜ä¸ºå·¥ä»¶"
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "ğŸ’¬ å¦‚å‘ç°å®‰å…¨é—®é¢˜ï¼Œå·²åœ¨ PR ä¸­æ·»åŠ è¯„è®º"
          fi
